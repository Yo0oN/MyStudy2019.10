package MyBatisModelPagingModel;

import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;

import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

public class MyBatisPagingBoardDAO {
	private SqlSession sqlSession;
	private MapperInter mapper;

	public MyBatisPagingBoardDAO() {
		String resource = "myBatisConfig.xml";

		InputStream is = null;

		try {
			is = Resources.getResourceAsStream(resource);
			SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(is);
			this.sqlSession = sqlSessionFactory.openSession(true);

			sqlSession.getConfiguration().addMapper(MapperInter.class);
			this.mapper = sqlSession.getMapper(MapperInter.class);
		} catch (IOException e) {
			System.out.println("error : " + e.getMessage());
		} finally {
			if (is != null) {
				try {
					is.close();
				} catch (IOException e) {
				}
			}
		}

	}

	// board_list1.jsp
	public MyBatisPagingBoardListTO boardList(MyBatisPagingBoardListTO listTO) {

		MyBatisPagingBoardListTO boardList = new MyBatisPagingBoardListTO();

		// 현재 페이지
		int cpage = listTO.getCpage();
		// 한 페이지당 보일 글 수
		int recordPerPage = listTO.getRecordPerPage();
		// 한 페이지에 보일 페이지 이동 번호 수
		int blockPerPage = listTO.getBlockPerPage();
		// 현재페이지에서 보이는 글의 시작번호
		int fromIndex = (cpage -1) * recordPerPage;
		listTO.setFromIndex(fromIndex);
		// DB에서 받아온 후 설정해주기
		boardList.setBoardLists(mapper.selectList());


		
		// 전체 글 수
		int totalRecord = boardList.getBoardLists().size();
		listTO.setTotalRecord(totalRecord);
		// 총 페이지 수
		int totalPage = ((totalRecord - 1) / recordPerPage) + 1;
		listTO.setTotalPage(totalPage);
		// 현재 보이는 페이지 이동 번호의 시작번호
		int startBlock = ((cpage - 1) / blockPerPage) * blockPerPage + 1;
		// 현재 보이는 페이지 이동 번호의 끝번호
		int endBlock = startBlock + blockPerPage - 1 + blockPerPage;

		
		
//		// 페이지에서 보이는 글의 시작 번호
//		int fromIndex = (cpage - 1) * recordPerPage;
//		// 페이지에서 보이는 글의 마지막번호
//		int toIndex = fromIndex + recordPerPage;
//		// 마지막페이지의 글이 10개가 안될경우 toIndex를 조정해준다.
//		if (toIndex >= listTO.getTotalRecord()) {
//			toIndex = listTO.getTotalRecord();
//		}
//
//		// 실제로 보여질 글들만 담을 boardListsShow
//		// subList(시작번호, 끝번호) List안에서 시작번호부터 끝번호까지만 List로 반환한다.
//		ArrayList<MyBatisPagingBoardTO> boardListsShow = new ArrayList<>(boardLists.subList(fromIndex, toIndex));
//
//		/*
//		 * // 보여질글 개수만큼만 담아둔다. 위의 56~67행의 내용과 같은뜻이다. ArrayList<MyBatisPagingBoardTO>
//		 * boardListsShow = new ArrayList(); for (int i = fromIndex; i < (fromIndex +
//		 * recordPerPage) && !boardLists.isEmpty(); i++) {
//		 * boardListsShow.add(boardLists.get(i)); }
//		 */
//
//		// 담은것을 listTO에 넘긴다.
//		listTO.setBoardLists(boardListsShow);
//
//		if (listTO.getEndBlock() >= listTO.getTotalPage()) {
//			listTO.setEndBlock(listTO.getTotalPage());
//		}
//
//		if (sqlSession != null) {
//			sqlSession.close();
//		}
//
		return listTO;
	}

	// board_write1.jsp
	public void boardWrite() {
		// 사용하지 않음

	}

	// board_write1_ok.jsp
	public int boardWriteOk(MyBatisPagingBoardTO to) {
		int flag = 1;
		int result = sqlSession.insert("writeOk", to);

		if (result == 1) {
			flag = 0;
		}

		if (sqlSession != null) {
			sqlSession.close();
		}

		return flag;
	}

	public MyBatisPagingBoardTO boardView(MyBatisPagingBoardTO to) {
		// 글을 보게되면 조회수를 먼저 올린 후
		sqlSession.update("view_hit", to);
		// 글을 보여준다.
		to = sqlSession.selectOne("view", to);

		if (sqlSession != null)
			sqlSession.close();

		return to;
	}

	public MyBatisPagingBoardTO boardModify(MyBatisPagingBoardTO to) {

		to = sqlSession.selectOne("modify", to);

		if (sqlSession != null)
			sqlSession.close();

		return to;
	}

	public int boardModifyOk(MyBatisPagingBoardTO to) {
		int flag = 2;

		int result = sqlSession.update("modifyOk", to);

		if (result == 1) {
			flag = 0;
		} else if (result == 0) {
			flag = 1;
		}
		return flag;
	}

	public MyBatisPagingBoardTO boardDelete(MyBatisPagingBoardTO to) {

		to = sqlSession.selectOne("delete", to);

		if (sqlSession != null)
			sqlSession.close();

		return to;
	}

	public int boardDeleteOk(MyBatisPagingBoardTO to) {
		int flag = 2;
		int result = sqlSession.delete("deleteOk", to);

		if (result == 0) {
			flag = 1;
		} else if (result == 1) {
			flag = 0;
		}

		if (sqlSession != null)
			sqlSession.close();

		return flag;
	}
}
